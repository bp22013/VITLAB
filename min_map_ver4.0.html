<!DOCTYPE html>
<html>
    <head>
        <title>経路探索マップ</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
        <link href="/dist/output.css" rel="stylesheet" />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
        />
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@turf/turf/turf.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
        <style>
            .range-slider::-webkit-slider-thumb {
                appearance: none;
                width: 18px;
                height: 18px;
                border-radius: 50%;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                cursor: pointer;
                box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
                border: 2px solid white;
                transition: all 0.2s ease;
            }

            .range-slider::-webkit-slider-thumb:hover {
                transform: scale(1.1);
                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.6);
            }

            .gradient-bg {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            }

            .glass-effect {
                background: rgba(255, 255, 255, 0.15);
                backdrop-filter: blur(12px);
                border: 1px solid rgba(255, 255, 255, 0.2);
            }

            .card-shadow {
                box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1),
                    0 10px 10px -5px rgba(0, 0, 0, 0.04);
            }

            /* Toast CSS */
            #toast-container {
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                z-index: 9999;
                display: flex;
                flex-direction: column;
                gap: 10px;
            }
            .toast {
                padding: 12px 20px;
                border-radius: 8px;
                font-size: 14px;
                color: white;
                opacity: 0;
                transform: translateY(-20px);
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                gap: 10px;
                background: rgba(40, 150, 255, 0.5);
                backdrop-filter: blur(12px);
                border: 1px solid rgba(40, 150, 255, 0.6);
            }
            .toast.show {
                opacity: 1;
                transform: translateY(0);
            }
            .toast.success {
                background: rgba(30, 200, 100, 0.5);
                border-color: rgba(30, 200, 100, 0.6);
            }
        </style>
    </head>
    <body class="gradient-bg min-h-screen">
        <div
            id="loading-overlay"
            class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-999 flex items-center justify-center"
        >
            <div class="glass-effect rounded-2xl p-8 flex items-center space-x-4 text-white">
                <div
                    class="w-8 h-8 border-3 border-white/30 border-t-white rounded-full animate-spin"
                ></div>
                <div id="loading-message" class="text-lg font-medium">読み込み中...</div>
            </div>
        </div>

        <div class="min-h-screen p-4">
            <div class="max-w-8xl mx-auto space-y-6">
                <div class="grid grid-cols-2 gap-4">
                    <div class="glass-effect rounded-xl p-6">
                        <h3 class="text-white font-semibold text-lg mb-4 flex items-center gap-2">
                            <i class="fas fa-eye text-yellow-300"></i>
                            表示データ
                        </h3>
                        <div class="grid grid-cols-6 gap-2">
                            <button
                                onclick="viewAREA('./RE_AREA.geojson')"
                                class="bg-gray-600 hover:bg-gray-500 text-white text-xs py-2 px-2 rounded-lg transition-all duration-200 hover:scale-105"
                            >
                                対象範囲
                            </button>
                            <button
                                onclick="displayDataFromCSV('sidewalk', 'red')"
                                class="bg-red-600 hover:bg-red-500 text-white text-xs py-2 px-2 rounded-lg transition-all duration-200 hover:scale-105"
                            >
                                歩道
                            </button>
                            <button
                                onclick="displayDataFromCSV('signal', 'blue')"
                                class="bg-blue-600 hover:bg-blue-500 text-white text-xs py-2 px-2 rounded-lg transition-all duration-200 hover:scale-105"
                            >
                                信号
                            </button>
                            <button
                                onclick="displayDataFromCSV('road_width1', 'purple')"
                                class="bg-purple-600 hover:bg-purple-500 text-white text-xs py-2 px-2 rounded-lg transition-all duration-200 hover:scale-105"
                            >
                                道路幅1
                            </button>
                            <button
                                onclick="displayDataFromCSV('road_width2', 'brown')"
                                class="bg-yellow-700 hover:bg-yellow-600 text-white text-xs py-2 px-2 rounded-lg transition-all duration-200 hover:scale-105"
                            >
                                道路幅2
                            </button>
                            <button
                                onclick="displayDataFromCSV('road_width3', 'darkgreen')"
                                class="bg-green-700 hover:bg-green-600 text-white text-xs py-2 px-2 rounded-lg transition-all duration-200 hover:scale-105"
                            >
                                道路幅3
                            </button>
                            <button
                                onclick="displayDataFromCSV('illumination','orange')"
                                class="bg-orange-600 hover:bg-orange-500 text-white text-xs py-2 px-2 rounded-lg transition-all duration-200 hover:scale-105"
                            >
                                照明
                            </button>
                            <button
                                onclick="displayDataFromCSV('nature','green')"
                                class="bg-green-600 hover:bg-green-500 text-white text-xs py-2 px-2 rounded-lg transition-all duration-200 hover:scale-105"
                            >
                                自然
                            </button>
                            <button
                                onclick="displayDataFromCSV('park','red')"
                                class="bg-red-700 hover:bg-red-600 text-white text-xs py-2 px-2 rounded-lg transition-all duration-200 hover:scale-105"
                            >
                                公園
                            </button>
                            <button
                                onclick="displayDataFromCSV('garbage','orange')"
                                class="bg-orange-500 hover:bg-orange-400 text-white text-xs py-2 px-2 rounded-lg transition-all duration-200 hover:scale-105"
                            >
                                ごみ
                            </button>
                            <button
                                onclick="displayDataFromCSV('toilet', '#ff1493')"
                                class="bg-pink-600 hover:bg-pink-500 text-white text-xs py-2 px-2 rounded-lg transition-all duration-200 hover:scale-105"
                            >
                                トイレ
                            </button>
                            <button
                                onclick="displayDataFromCSV('crosswalk','red')"
                                class="bg-indigo-600 hover:bg-indigo-500 text-white text-xs py-2 px-2 rounded-lg transition-all duration-200 hover:scale-105"
                            >
                                横断歩道
                            </button>
                        </div>
                    </div>
                    <div class="xl:col-span-1 flex flex-col">
                        <div class="glass-effect rounded-xl p-4 flex-grow">
                            <h3 class="text-white font-semibold mb-3 flex items-center gap-2">
                                <i class="fas fa-info-circle text-yellow-300"></i>
                                経路情報
                            </h3>
                            <div id="route-info" class="flex gap-3 text-white/90 text-sm flex-wrap">
                                経路を検索すると詳細情報が表示されます
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-9 gap-6">
                    <div class="xl:col-span-2 flex flex-col gap-6">
                        <div class="glass-effect rounded-xl p-6">
                            <h3
                                class="text-white font-semibold text-lg mb-4 flex items-center gap-2"
                            >
                                <i class="fas fa-map-marker-alt text-yellow-300"></i>
                                地点設定
                            </h3>
                            <div class="space-x-2 flex">
                                <div>
                                    <label class="block text-white/90 text-sm font-medium mb-2">
                                        <i class="fas fa-play text-green-400 mr-1"></i>
                                        始点 (1-246)
                                    </label>
                                    <input
                                        type="text"
                                        id="param1"
                                        value="1"
                                        class="w-full pl-2 rounded-lg bg-white/20 text-white border border-white/30 placeholder-white/50 focus:border-yellow-300 focus:outline-none transition-all duration-200"
                                        placeholder="始点ノード番号"
                                    />
                                </div>
                                <div>
                                    <label class="block text-white/90 text-sm font-medium mb-2">
                                        <i class="fas fa-stop text-red-400 mr-1"></i> 終点 (1-246)
                                    </label>
                                    <input
                                        type="text"
                                        id="param2"
                                        value="246"
                                        class="w-full pl-2 rounded-lg bg-white/20 text-white border border-white/30 placeholder-white/50 focus:border-yellow-300 focus:outline-none transition-all duration-200"
                                        placeholder="終点ノード番号"
                                    />
                                </div>
                            </div>
                        </div>

                        <div class="glass-effect rounded-xl p-6">
                            <h3
                                class="text-white font-semibold text-lg mb-4 flex items-center gap-2"
                            >
                                <i class="fas fa-walking text-yellow-300"></i>
                                歩行速度設定
                            </h3>
                            <div>
                                <label class="block text-white/90 text-sm font-medium mb-2">
                                    速度 (m/分)
                                </label>
                                <input
                                    type="number"
                                    id="walking-speed"
                                    value="80"
                                    class="w-full pl-2 rounded-lg bg-white/20 text-white border border-white/30 placeholder-white/50 focus:border-yellow-300 focus:outline-none transition-all duration-200"
                                    placeholder="例: 80"
                                />
                            </div>
                        </div>

                        <div class="glass-effect rounded-xl p-4">
                            <h3 class="text-white font-semibold mb-3 flex items-center gap-2">
                                <i class="fas fa-save text-yellow-300"></i>
                                ルート保存・参照
                            </h3>
                            <div class="space-y-3">
                                <div class="grid grid-cols-2 gap-2">
                                    <button
                                        onclick="saveRoute(1)"
                                        class="bg-green-500 hover:bg-green-600 text-white text-xs py-2 px-3 rounded-lg transition-all duration-200 hover:scale-105 flex items-center justify-center gap-1"
                                    >
                                        <i class="fas fa-download"></i>経路1
                                    </button>
                                    <button
                                        onclick="saveRoute(2)"
                                        class="bg-green-500 hover:bg-green-600 text-white text-xs py-2 px-3 rounded-lg transition-all duration-200 hover:scale-105 flex items-center justify-center gap-1"
                                    >
                                        <i class="fas fa-download"></i>経路2
                                    </button>
                                </div>
                                <div class="flex gap-2">
                                    <select
                                        id="saved-routes-dropdown"
                                        class="flex-1 text-xs p-2 rounded-lg bg-white/20 text-white border border-white/30 focus:border-yellow-300 focus:outline-none"
                                    >
                                        <option>読み込み中...</option>
                                    </select>
                                    <button
                                        onclick="loadSelectedRoute()"
                                        class="bg-blue-500 hover:bg-blue-600 text-white text-xs py-2 px-3 rounded-lg transition-all duration-200 hover:scale-105"
                                    >
                                        <i class="fas fa-upload"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="glass-effect rounded-xl p-3">
                            <h3
                                class="text-white font-semibold text-lg mb-1 flex items-center gap-2"
                            >
                                <i class="fas fa-mountain text-yellow-300"></i>
                                勾配制限
                            </h3>
                            <div class="space-y-1">
                                <div>
                                    <label class="block text-white/90 text-sm font-medium"
                                        >上りの最大勾配 (m/m)</label
                                    >
                                    <div class="flex items-center gap-3">
                                        <input
                                            type="range"
                                            id="weight2"
                                            value="100"
                                            min="0"
                                            max="100"
                                            step="0.1"
                                            class="range-slider flex-1 h-2 bg-white/20 rounded-full appearance-none cursor-pointer"
                                            oninput="syncValues(this, 'textweight2')"
                                        />
                                        <input
                                            type="text"
                                            id="textweight2"
                                            value="100"
                                            class="w-16 px-2 py-1 text-xs text-center rounded bg-white/20 text-white border border-white/30 focus:border-yellow-300 focus:outline-none"
                                            oninput="syncValues(this, 'weight2')"
                                        />
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-white/90 text-sm font-medium"
                                        >下りの最大勾配 (m/m)</label
                                    >
                                    <div class="flex items-center gap-3">
                                        <input
                                            type="range"
                                            id="weight3"
                                            value="-100"
                                            min="-100"
                                            max="0"
                                            step="0.1"
                                            class="range-slider flex-1 h-2 bg-white/20 rounded-full appearance-none cursor-pointer"
                                            oninput="syncValues(this, 'textweight3')"
                                        />
                                        <input
                                            type="text"
                                            id="textweight3"
                                            value="-100"
                                            class="w-16 px-2 py-1 text-xs text-center rounded bg-white/20 text-white border border-white/30 focus:border-yellow-300 focus:outline-none"
                                            oninput="syncValues(this, 'weight3')"
                                        />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="xl:col-span-4">
                        <div
                            class="bg-white rounded-2xl overflow-hidden card-shadow h-[375px] mb-3"
                        >
                            <div id="map" style="height: 400px"></div>
                        </div>
                        <div class="glass-effect rounded-xl p-4 flex flex-col">
                            <h3 class="text-white font-semibold mb-3 flex items-center gap-2">
                                <i class="fas fa-play-circle text-yellow-300"></i>
                                計算実行
                            </h3>
                            <div class="grid grid-cols-3 gap-2">
                                <button
                                    onclick="loadRouteFromCSV()"
                                    class="w-full bg-red-500 hover:bg-red-600 text-white text-sm py-2 rounded-lg transition-all duration-200 hover:scale-105 flex items-center justify-center gap-2"
                                >
                                    <i class="fas fa-route"></i>経路1を計算
                                </button>
                                <button
                                    onclick="loadRouteFromCSV2()"
                                    class="w-full bg-blue-500 hover:bg-blue-600 text-white text-sm py-2 rounded-lg transition-all duration-200 hover:scale-105 flex items-center justify-center gap-2"
                                >
                                    <i class="fas fa-route"></i>経路2を計算
                                </button>
                                <button
                                    onclick="clearGeoJSON()"
                                    class="w-full bg-gray-500 hover:bg-gray-600 text-white text-sm py-2 rounded-lg transition-all duration-200 hover:scale-105 flex items-center justify-center gap-2"
                                >
                                    <i class="fas fa-trash"></i>クリア
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="glass-effect rounded-xl p-4 col-span-3">
                        <h3 class="text-white font-semibold text-xl mb-4 flex items-center gap-2">
                            <i class="fas fa-sliders-h text-yellow-300"></i>
                            重み設定
                        </h3>
                        <div
                            class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 xl:grid-cols-2 gap-2"
                        >
                            <!-- 距離 -->
                            <div
                                class="bg-white/10 p-3 rounded-lg border border-white/20 flex flex-col space-y-2"
                            >
                                <div class="flex items-center justify-between">
                                    <label class="text-white/90 text-sm font-medium"
                                        >距離 (+)</label
                                    >
                                    <input
                                        type="text"
                                        id="textweight0"
                                        value="0"
                                        class="w-14 px-1 py-0.5 text-xs text-center rounded bg-white/20 text-white border border-white/30 focus:border-yellow-300 focus:outline-none"
                                        oninput="syncValues(this, 'weight0')"
                                    />
                                </div>
                                <input
                                    type="range"
                                    id="weight0"
                                    value="0"
                                    min="-100.0"
                                    max="100.0"
                                    step="0.1"
                                    class="range-slider w-full h-1 bg-white/20 rounded-full appearance-none cursor-pointer"
                                    oninput="syncValues(this, 'textweight0')"
                                />
                            </div>

                            <!-- 勾配 -->
                            <div
                                class="bg-white/10 p-3 rounded-lg border border-white/20 flex flex-col space-y-2"
                            >
                                <div class="flex items-center justify-between">
                                    <label class="text-white/90 text-sm font-medium"
                                        >勾配 (+)</label
                                    >
                                    <input
                                        type="text"
                                        id="textweight1"
                                        value="0"
                                        class="w-14 px-1 py-0.5 text-xs text-center rounded bg-white/20 text-white border border-white/30 focus:border-yellow-300 focus:outline-none"
                                        oninput="syncValues(this, 'weight1')"
                                    />
                                </div>
                                <input
                                    type="range"
                                    id="weight1"
                                    value="0"
                                    min="-100.0"
                                    max="100.0"
                                    step="0.1"
                                    class="range-slider w-full h-1 bg-white/20 rounded-full appearance-none cursor-pointer"
                                    oninput="syncValues(this, 'textweight1')"
                                />
                            </div>

                            <!-- 歩道 -->
                            <div
                                class="bg-white/10 p-3 rounded-lg border border-white/20 flex flex-col space-y-2"
                            >
                                <div class="flex items-center justify-between">
                                    <label class="text-white/90 text-sm font-medium"
                                        >歩道 (-)</label
                                    >
                                    <input
                                        type="text"
                                        id="textweight4"
                                        value="0"
                                        class="w-14 px-1 py-0.5 text-xs text-center rounded bg-white/20 text-white border border-white/30 focus:border-yellow-300 focus:outline-none"
                                        oninput="syncValues(this, 'weight4')"
                                    />
                                </div>
                                <input
                                    type="range"
                                    id="weight4"
                                    value="0"
                                    min="-100.0"
                                    max="100.0"
                                    step="0.1"
                                    class="range-slider w-full h-1 bg-white/20 rounded-full appearance-none cursor-pointer"
                                    oninput="syncValues(this, 'textweight4')"
                                />
                            </div>

                            <!-- 信号 -->
                            <div
                                class="bg-white/10 p-3 rounded-lg border border-white/20 flex flex-col space-y-2"
                            >
                                <div class="flex items-center justify-between">
                                    <label class="text-white/90 text-sm font-medium"
                                        >信号 (+)</label
                                    >
                                    <input
                                        type="text"
                                        id="textweight5"
                                        value="0"
                                        class="w-14 px-1 py-0.5 text-xs text-center rounded bg-white/20 text-white border border-white/30 focus:border-yellow-300 focus:outline-none"
                                        oninput="syncValues(this, 'weight5')"
                                    />
                                </div>
                                <input
                                    type="range"
                                    id="weight5"
                                    value="0"
                                    min="-100.0"
                                    max="100.0"
                                    step="0.1"
                                    class="range-slider w-full h-1 bg-white/20 rounded-full appearance-none cursor-pointer"
                                    oninput="syncValues(this, 'textweight5')"
                                />
                            </div>

                            <!-- 道路幅 -->
                            <div
                                class="bg-white/10 p-3 rounded-lg border border-white/20 flex flex-col space-y-2"
                            >
                                <div class="flex items-center justify-between">
                                    <label class="text-white/90 text-sm font-medium"
                                        >道路幅 (+)</label
                                    >
                                    <input
                                        type="text"
                                        id="textweight6"
                                        value="0"
                                        class="w-14 px-1 py-0.5 text-xs text-center rounded bg-white/20 text-white border border-white/30 focus:border-yellow-300 focus:outline-none"
                                        oninput="syncValues(this, 'weight6')"
                                    />
                                </div>
                                <input
                                    type="range"
                                    id="weight6"
                                    value="0"
                                    min="-100.0"
                                    max="100.0"
                                    step="0.1"
                                    class="range-slider w-full h-1 bg-white/20 rounded-full appearance-none cursor-pointer"
                                    oninput="syncValues(this, 'textweight6')"
                                />
                            </div>

                            <!-- 照明 -->
                            <div
                                class="bg-white/10 p-3 rounded-lg border border-white/20 flex flex-col space-y-2"
                            >
                                <div class="flex items-center justify-between">
                                    <label class="text-white/90 text-sm font-medium"
                                        >照明 (-)</label
                                    >
                                    <input
                                        type="text"
                                        id="textweight7"
                                        value="0"
                                        class="w-14 px-1 py-0.5 text-xs text-center rounded bg-white/20 text-white border border-white/30 focus:border-yellow-300 focus:outline-none"
                                        oninput="syncValues(this, 'weight7')"
                                    />
                                </div>
                                <input
                                    type="range"
                                    id="weight7"
                                    value="0"
                                    min="-100.0"
                                    max="100.0"
                                    step="0.1"
                                    class="range-slider w-full h-1 bg-white/20 rounded-full appearance-none cursor-pointer"
                                    oninput="syncValues(this, 'textweight7')"
                                />
                            </div>

                            <!-- 自然 -->
                            <div
                                class="bg-white/10 p-3 rounded-lg border border-white/20 flex flex-col space-y-2"
                            >
                                <div class="flex items-center justify-between">
                                    <label class="text-white/90 text-sm font-medium"
                                        >自然 (-)</label
                                    >
                                    <input
                                        type="text"
                                        id="textweight8"
                                        value="0"
                                        class="w-14 px-1 py-0.5 text-xs text-center rounded bg-white/20 text-white border border-white/30 focus:border-yellow-300 focus:outline-none"
                                        oninput="syncValues(this, 'weight8')"
                                    />
                                </div>
                                <input
                                    type="range"
                                    id="weight8"
                                    value="0"
                                    min="-100.0"
                                    max="100.0"
                                    step="0.1"
                                    class="range-slider w-full h-1 bg-white/20 rounded-full appearance-none cursor-pointer"
                                    oninput="syncValues(this, 'textweight8')"
                                />
                            </div>

                            <!-- 公園 -->
                            <div
                                class="bg-white/10 p-3 rounded-lg border border-white/20 flex flex-col space-y-2"
                            >
                                <div class="flex items-center justify-between">
                                    <label class="text-white/90 text-sm font-medium"
                                        >公園 (-)</label
                                    >
                                    <input
                                        type="text"
                                        id="textweight9"
                                        value="0"
                                        class="w-14 px-1 py-0.5 text-xs text-center rounded bg-white/20 text-white border border-white/30 focus:border-yellow-300 focus:outline-none"
                                        oninput="syncValues(this, 'weight9')"
                                    />
                                </div>
                                <input
                                    type="range"
                                    id="weight9"
                                    value="0"
                                    min="-100.0"
                                    max="100.0"
                                    step="0.1"
                                    class="range-slider w-full h-1 bg-white/20 rounded-full appearance-none cursor-pointer"
                                    oninput="syncValues(this, 'textweight9')"
                                />
                            </div>

                            <!-- ごみ -->
                            <div
                                class="bg-white/10 p-3 rounded-lg border border-white/20 flex flex-col space-y-2"
                            >
                                <div class="flex items-center justify-between">
                                    <label class="text-white/90 text-sm font-medium"
                                        >ごみ集積場 (+)</label
                                    >
                                    <input
                                        type="text"
                                        id="textweight10"
                                        value="0"
                                        class="w-14 px-1 py-0.5 text-xs text-center rounded bg-white/20 text-white border border-white/30 focus:border-yellow-300 focus:outline-none"
                                        oninput="syncValues(this, 'weight10')"
                                    />
                                </div>
                                <input
                                    type="range"
                                    id="weight10"
                                    value="0"
                                    min="-100.0"
                                    max="100.0"
                                    step="0.1"
                                    class="range-slider w-full h-1 bg-white/20 rounded-full appearance-none cursor-pointer"
                                    oninput="syncValues(this, 'textweight10')"
                                />
                            </div>

                            <!-- トイレ -->
                            <div
                                class="bg-white/10 p-3 rounded-lg border border-white/20 flex flex-col space-y-2"
                            >
                                <div class="flex items-center justify-between">
                                    <label class="text-white/90 text-sm font-medium"
                                        >公衆トイレ (-)</label
                                    >
                                    <input
                                        type="text"
                                        id="textweight11"
                                        value="0"
                                        class="w-14 px-1 py-0.5 text-xs text-center rounded bg-white/20 text-white border border-white/30 focus:border-yellow-300 focus:outline-none"
                                        oninput="syncValues(this, 'weight11')"
                                    />
                                </div>
                                <input
                                    type="range"
                                    id="weight11"
                                    value="0"
                                    min="-100.0"
                                    max="100.0"
                                    step="0.1"
                                    class="range-slider w-full h-1 bg-white/20 rounded-full appearance-none cursor-pointer"
                                    oninput="syncValues(this, 'textweight11')"
                                />
                            </div>

                            <!-- 横断歩道 -->
                            <div
                                class="bg-white/10 p-3 rounded-lg border border-white/20 flex flex-col space-y-2"
                            >
                                <div class="flex items-center justify-between">
                                    <label class="text-white/90 text-sm font-medium"
                                        >横断歩道 (-)</label
                                    >
                                    <input
                                        type="text"
                                        id="textweight12"
                                        value="0"
                                        class="w-14 px-1 py-0.5 text-xs text-center rounded bg-white/20 text-white border border-white/30 focus:border-yellow-300 focus:outline-none"
                                        oninput="syncValues(this, 'weight12')"
                                    />
                                </div>
                                <input
                                    type="range"
                                    id="weight12"
                                    value="0"
                                    min="-100.0"
                                    max="100.0"
                                    step="0.1"
                                    class="range-slider w-full h-1 bg-white/20 rounded-full appearance-none cursor-pointer"
                                    oninput="syncValues(this, 'textweight12')"
                                />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="toast-container"></div>

        <script>
            let map = L.map('map', { center: [35.95017, 139.64735], zoom: 15 });
            let tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution:
                    '© <a href="http://osm.org/copyright">OpenStreetMap</a> contributors, ' +
                    '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',
            });
            tileLayer.addTo(map);

            const showToast = (message, type = 'info', duration = 3000) => {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;

                let iconClass = 'fas fa-info-circle';
                if (type === 'success') {
                    iconClass = 'fas fa-check-circle';
                }

                toast.innerHTML = `<i class="${iconClass}"></i><span>${message}</span>`;

                container.appendChild(toast);

                // Animate in
                setTimeout(() => {
                    toast.classList.add('show');
                }, 10);

                // Animate out and remove
                setTimeout(() => {
                    toast.classList.remove('show');
                    toast.addEventListener('transitionend', () => {
                        toast.remove();
                    });
                }, duration);
            };

            // State management
            let route1 = { info: null, segments: [], layers: [] };
            let route2 = { info: null, segments: [], layers: [] };
            let savedRoute = { info: null, layers: [] };
            let otherLayers = [];
            let routeData = [];

            const formatTime = (minutes) => {
                if (minutes === null || isNaN(minutes)) {
                    return '0分00秒';
                }
                const totalSeconds = Math.round(minutes * 60);
                const displayMinutes = Math.floor(totalSeconds / 60);
                const displaySeconds = totalSeconds % 60;
                return `${displayMinutes}分${displaySeconds.toString().padStart(2, '0')}秒`;
            };

            const updateRouteInfoDisplay = () => {
                const infoDiv = document.getElementById('route-info');
                let content = '';
                let hasInfo = false;

                if (route1.info) {
                    hasInfo = true;
                    content += `
                        <div class="bg-red-500/20 border border-red-300/30 rounded-lg p-2">
                            <h4 class="text-red-200 font-semibold mb-2 flex items-center gap-2">
                                <i class="fas fa-route"></i>経路1 (赤)
                            </h4>
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                <div class="bg-white/10 rounded p-1 text-center">
                                    <div class="text-white/70 text-xs">総距離</div>
                                    <div class="text-white font-semibold">${route1.info.totalDistance.toFixed(
                                        0
                                    )} m</div>
                                </div>
                                <div class="bg-white/10 rounded p-1 text-center">
                                    <div class="text-white/70 text-xs">所要時間</div>
                                    <div class="text-white font-semibold">${formatTime(
                                        route1.info.totalTime
                                    )}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                if (route2.info) {
                    hasInfo = true;
                    content += `
                        <div class="bg-blue-500/20 border border-blue-300/30 rounded-lg p-2">
                            <h4 class="text-blue-200 font-semibold mb-2 flex items-center gap-2">
                                <i class="fas fa-route"></i>経路2 (青)
                            </h4>
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                <div class="bg-white/10 rounded p-1 text-center">
                                    <div class="text-white/70 text-xs">総距離</div>
                                    <div class="text-white font-semibold">${route2.info.totalDistance.toFixed(
                                        0
                                    )} m</div>
                                </div>
                                <div class="bg-white/10 rounded p-1 text-center">
                                    <div class="text-white/70 text-xs">所要時間</div>
                                    <div class="text-white font-semibold">${formatTime(
                                        route2.info.totalTime
                                    )}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                if (savedRoute.info) {
                    hasInfo = true;
                    content += `
                        <div class="bg-green-500/20 border border-green-300/30 rounded-lg p-2">
                            <h4 class="text-green-200 font-semibold mb-2 flex items-center gap-2">
                                <i class="fas fa-route"></i>呼び出し経路 (緑)
                            </h4>
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                <div class="bg-white/10 rounded p-1 text-center">
                                    <div class="text-white/70 text-xs">総距離</div>
                                    <div class="text-white font-semibold">${savedRoute.info.totalDistance.toFixed(
                                        0
                                    )} m</div>
                                </div>
                                <div class="bg-white/10 rounded p-1 text-center">
                                    <div class="text-white/70 text-xs">所要時間</div>
                                    <div class="text-white font-semibold">${formatTime(
                                        savedRoute.info.totalTime
                                    )}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                if (!hasInfo) {
                    content =
                        '<div class="text-white/70 text-center italic text-sm">経路を検索すると詳細情報が表示されます</div>';
                }
                infoDiv.innerHTML = content;
            };

            const setLoadingState = (isLoading, message = '') => {
                const overlay = document.getElementById('loading-overlay');
                const messageElement = document.getElementById('loading-message');
                const controls = document.querySelectorAll('button, input, select');

                if (isLoading) {
                    messageElement.textContent = message;
                    overlay.classList.remove('hidden');
                    controls.forEach((control) => (control.disabled = true));
                } else {
                    overlay.classList.add('hidden');
                    controls.forEach((control) => (control.disabled = false));
                }
            };

            const loadCSVData = async () => {
                if (routeData.length > 0) return routeData;
                try {
                    const response = await fetch('./oomiya_route_inf_4.csv');
                    const csvText = await response.text();
                    const parsed = Papa.parse(csvText, {
                        header: true,
                        dynamicTyping: true,
                        skipEmptyLines: true,
                    });
                    routeData = parsed.data;
                    return routeData;
                } catch (error) {
                    console.error('CSVデータのロードに失敗:', error);
                    return [];
                }
            };

            const calculateRouteInfo = (segments, sourceData) => {
                if (!sourceData || sourceData.length === 0) {
                    console.error('経路情報データ(CSV)が読み込まれていません。');

                    return null;
                }

                let totalDistance = 0;

                let totalTime = 0;

                const speedInput = document.getElementById('walking-speed');

                const speed = parseFloat(speedInput.value) || 80; // m/min

                const routeDataMap = new Map();

                sourceData.forEach((row) => {
                    if (row.node1 !== undefined && row.node2 !== undefined) {
                        routeDataMap.set(`${row.node1}-${row.node2}`, row);
                    }
                });

                segments.forEach((segment) => {
                    const fileName = segment.replace('.geojson', '');

                    const routeInfo = routeDataMap.get(fileName);

                    if (routeInfo) {
                        totalDistance += routeInfo.distance || 0;
                    } else {
                        const nodes = fileName.split('-');

                        if (nodes.length === 2) {
                            const reverseRouteInfo = routeDataMap.get(`${nodes[1]}-${nodes[0]}`);

                            if (reverseRouteInfo) {
                                totalDistance += reverseRouteInfo.distance || 0;
                            } else {
                                console.warn(`経路情報が見つかりません: ${segment}`);
                            }
                        }
                    }
                });

                if (speed > 0) {
                    totalTime = totalDistance / speed;
                }

                return { totalDistance, totalTime };
            };

            const drawRouteFromResult = async (result, color, weight, routeId) => {
                const targetRoute = routeId === 1 ? route1 : route2;

                targetRoute.layers.forEach((layer) => map.removeLayer(layer));

                targetRoute.layers = [];

                const segments = result.userPref.split('\n').filter((line) => line.trim() !== '');

                targetRoute.segments = segments;

                const geojsonFiles = segments.map((line) => line.trim());

                const geojsonFolder = './oomiya_line/';

                targetRoute.info = {
                    totalDistance: result.totalDistance,
                    totalTime: result.totalTime
                };

                updateRouteInfoDisplay();

                await Promise.all(
                    geojsonFiles.map((filename) =>
                        fetch(geojsonFolder + filename)
                            .then((res) => {
                                if (!res.ok) throw new Error(`${filename}の読み込みに失敗`);

                                return res.json();
                            })

                            .then((data) => {
                                const geojsonLayer = L.geoJSON(data, {
                                    style: { color: color, weight: weight, opacity: 1.0 },
                                }).addTo(map);

                                targetRoute.layers.push(geojsonLayer);
                            })
                    )
                );
            };

            const loadRouteFromCSV = async () => {
                try {
                    setLoadingState(true, '経路1を計算中...');

                    await loadCSVData();

                    const result = await calc();

                    await drawRouteFromResult(result, '#ff4757', 10, 1);
                } catch (error) {
                    console.error('ルートの読み込みまたは計算中にエラーが発生しました:', error);

                    alert('エラーが発生しました: ' + error.message);
                } finally {
                    setLoadingState(false);
                }
            };

            const loadRouteFromCSV2 = async () => {
                try {
                    setLoadingState(true, '経路2を計算中...');

                    await loadCSVData();

                    const result = await calc();

                    await drawRouteFromResult(result, '#3742fa', 6, 2);
                } catch (error) {
                    console.error('ルートの読み込みまたは計算中にエラーが発生しました:', error);

                    alert('エラーが発生しました: ' + error.message);
                } finally {
                    setLoadingState(false);
                }
            };

            const saveRoute = async (routeId) => {
                const routeToSave = routeId === 1 ? route1 : route2;

                if (!routeToSave.segments || routeToSave.segments.length === 0) {
                    alert('保存する経路がありません。');

                    return;
                }

                const fileName = prompt('ファイル名を入力してください (例: route1.csv):');

                if (!fileName) {
                    return;
                }

                const masterDataMap = new Map();

                const header = Object.keys(routeData[0]).join(',');

                routeData.forEach((row) => {
                    masterDataMap.set(`${row.node1}-${row.node2}`, Object.values(row).join(','));
                });

                let csvContent = header + '\n';

                routeToSave.segments.forEach((segmentName) => {
                    const cleanName = segmentName.replace('.geojson', '');

                    const nodes = cleanName.split('-');

                    const key1 = `${nodes[0]}-${nodes[1]}`;

                    const key2 = `${nodes[1]}-${nodes[0]}`;

                    const row = masterDataMap.get(key1) || masterDataMap.get(key2);

                    if (row) {
                        csvContent += row + '\n';
                    }
                });

                const saveData = async (overwrite = false) => {
                    try {
                        const response = await fetch('/save_route', {
                            method: 'POST',

                            headers: { 'Content-Type': 'application/json' },

                            body: JSON.stringify({ fileName, csvContent, overwrite }),
                        });

                        const result = await response.json();

                        if (result.status === 'exists') {
                            if (
                                confirm(
                                    `ファイル "${result.finalFileName}" は既に存在します。上書きしますか？`
                                )
                            ) {
                                await saveData(true);
                            } else {
                                alert('保存をキャンセルしました。');
                            }
                        } else if (result.status === 'success') {
                            alert(
                                `経路が "${result.finalFileName}" としてサーバーに保存されました。`
                            );

                            loadSavedRoutesList();
                        } else {
                            alert(`保存中にエラーが発生しました: ${result.message}`);
                        }
                    } catch (error) {
                        console.error('保存エラー:', error);

                        alert('サーバーとの通信に失敗しました。');
                    }
                };

                await saveData();
            };

            const drawSavedRoute = async (csvContent) => {
                savedRoute.layers.forEach((layer) => map.removeLayer(layer));

                savedRoute.layers = [];

                const parsed = Papa.parse(csvContent, {
                    header: true,

                    dynamicTyping: true,

                    skipEmptyLines: true,
                });

                const savedSegmentsData = parsed.data;

                if (!savedSegmentsData || savedSegmentsData.length === 0) return;

                const segments = savedSegmentsData.map(
                    (row) => `${row.node1}-${row.node2}.geojson`
                );

                savedRoute.info = calculateRouteInfo(segments, savedSegmentsData);

                updateRouteInfoDisplay();

                const geojsonFolder = './oomiya_line/';

                await Promise.all(
                    segments.map((segmentFilename) =>
                        fetch(geojsonFolder + segmentFilename)
                            .then((res) => {
                                if (!res.ok) console.warn(`${segmentFilename}の読み込みに失敗`);

                                return res.json().catch(() => null);
                            })

                            .then((data) => {
                                if (data) {
                                    const geojsonLayer = L.geoJSON(data, {
                                        style: { color: '#2ed573', weight: 8, opacity: 0.8 },
                                    }).addTo(map);

                                    savedRoute.layers.push(geojsonLayer);
                                }
                            })
                    )
                );
            };

            const loadGeoAssign = (resultFile, color) => {
                let geojsonFolder = './oomiya_line/';

                fetch(resultFile)
                    .then((response) => {
                        if (!response.ok) throw new Error(`Failed to fetch ${resultFile}`);

                        return response.text();
                    })

                    .then((text) => {
                        var lines = text.split('\n').filter((line) => line.trim() !== '');

                        lines.forEach(function (filename) {
                            fetch(geojsonFolder + filename)
                                .then((response) => {
                                    if (!response.ok)
                                        throw new Error(`Failed to fetch ${filename}`);

                                    return response.json();
                                })

                                .then((data) => {
                                    var geojsonLayer = L.geoJSON(data, {
                                        style: { color: color, weight: 15, opacity: 0.2 },
                                    }).addTo(map);

                                    otherLayers.push(geojsonLayer);
                                })

                                .catch((error) =>
                                    console.error(`Error loading GeoJSON ${filename}:`, error)
                                );
                        });
                    })

                    .catch((error) => console.error(`Error loading ${resultFile}:`, error));
            };

            const drawGeoJSON = (url, color, weight, opacity) => {
                fetch(url)
                    .then((response) => {
                        if (!response.ok) {
                            if (response.status === 404) return null;

                            throw new Error(`Error loading GeoJSON`);
                        }

                        return response.json();
                    })

                    .then((data) => {
                        if (data) {
                            var geojsonLayer = L.geoJSON(data, {
                                style: { color: color, weight: weight, opacity: opacity },
                            }).addTo(map);

                            otherLayers.push(geojsonLayer);
                        }
                    })

                    .catch((error) => console.error(error.message));
            };

            const displayDataFromCSV = async (dataType, color) => {
                console.log(
                    `--- displayDataFromCSV called with dataType: ${dataType}, color: ${color} ---`
                );

                await loadCSVData();

                let geojsonFolder = './oomiya_line/';

                if (dataType === 'signal') {
                    let foundCount = 0;

                    routeData.forEach((row) => {
                        if (row.signal == 1) {
                            foundCount++;

                            const edgeName = `${row.node1}-${row.node2}`;

                            const url = geojsonFolder + edgeName + '.geojson';

                            console.log(
                                `Condition met for ${dataType}. Drawing interactive layer for: ${url}`
                            );

                            fetch(url)
                                .then((response) => {
                                    if (!response.ok) return; // Ignore missing geojson files silently

                                    return response.json();
                                })

                                .then((data) => {
                                    if (!data) return;

                                    const signalLayer = L.geoJSON(data, {
                                        style: { color: color, weight: 15, opacity: 0.5 },
                                    });

                                    signalLayer.bindPopup(
                                        `<b>信号区間: ${edgeName}</b><br>クリックで待ち時間を計算`
                                    );

                                    signalLayer.on('mouseover', function (e) {
                                        this.setStyle({ opacity: 0.8, weight: 20 });

                                        this.openPopup();
                                    });

                                    signalLayer.on('mouseout', function (e) {
                                        this.setStyle({ opacity: 0.5, weight: 15 });

                                        this.closePopup();
                                    });

                                    signalLayer.on('click', async () => {
                                        const speedInput = document.getElementById('walking-speed');

                                        const speed = parseFloat(speedInput.value);

                                        if (isNaN(speed) || speed <= 0) {
                                            alert('有効な歩行速度（m/分）を入力してください。');

                                            return;
                                        }

                                        const speedMps = speed / 60; // Convert m/min to m/s for backend

                                        let routeId = null;

                                        let targetRoute = null;

                                        const geojsonFilename = edgeName + '.geojson';

                                        if (route1.segments.includes(geojsonFilename)) {
                                            routeId = 1;

                                            targetRoute = route1;
                                        } else if (route2.segments.includes(geojsonFilename)) {
                                            routeId = 2;

                                            targetRoute = route2;
                                        } else {
                                            alert(
                                                'この信号は現在計算されている経路上にありません。'
                                            );

                                            return;
                                        }

                                        try {
                                            setLoadingState(
                                                true,
                                                `信号 ${edgeName} を基準に待ち時間を計算中...`
                                            );

                                            const pureRouteInfo = calculateRouteInfo(
                                                targetRoute.segments,
                                                routeData
                                            );

                                            const baseTime = pureRouteInfo.totalTime;

                                            const response = await fetch('/calculate-wait-time', {
                                                method: 'POST',

                                                headers: { 'Content-Type': 'application/json' },

                                                body: JSON.stringify({
                                                    referenceEdge: edgeName,
                                                    walkingSpeed: speedMps,
                                                }),
                                            });

                                            if (!response.ok) {
                                                const errData = await response.json();

                                                throw new Error(
                                                    errData.error ||
                                                        `計算エラー: ${response.statusText}`
                                                );
                                            }

                                            const result = await response.json();

                                            const newTotalTime = baseTime + result.totalWaitTime;

                                            targetRoute.info.totalTime = newTotalTime;

                                            updateRouteInfoDisplay();

                                            showToast(
                                                `経路${routeId}の所要時間を更新しました。`,
                                                'success'
                                            );
                                        } catch (error) {
                                            console.error('Wait time calculation error:', error);

                                            alert(
                                                `待ち時間計算中にエラーが発生しました: ${error.message}`
                                            );
                                        } finally {
                                            setLoadingState(false);
                                        }
                                    });

                                    signalLayer.addTo(map);

                                    otherLayers.push(signalLayer);
                                })

                                .catch((error) => {
                                    /* Silently ignore errors for missing files */
                                });
                        }
                    });

                    console.log(`Found ${foundCount} items for dataType '${dataType}'.`);

                    if (foundCount === 0) {
                        showToast(`'${dataType}' に該当するデータが見つかりませんでした。`, 'info');
                    }
                } else {
                    let foundCount = 0;

                    routeData.forEach(function (row) {
                        let conditionMet = false;

                        switch (dataType) {
                            case 'sidewalk':
                                if (row.sidewalk == 1) conditionMet = true;

                                break;

                            case 'nature':
                                if (row.nature == 1) conditionMet = true;

                                break;

                            case 'road_width1':
                                if (row.road_width == 1) conditionMet = true;

                                break;

                            case 'road_width2':
                                if (row.road_width == 2) conditionMet = true;

                                break;

                            case 'road_width3':
                                if (row.road_width >= 3) conditionMet = true;

                                break;

                            case 'park':
                                if (row.park >= 1) conditionMet = true;

                                break;

                            case 'illumination':
                                if (row.illumination >= 1) conditionMet = true;

                                break;

                            case 'crosswalk':
                                if (row.crosswalk >= 1) conditionMet = true;

                                break;

                            case 'garbage':
                                if (row.garbage >= 1) conditionMet = true;

                                break;

                            case 'toilet':
                                if (row.toilet == 1) conditionMet = true;

                                break;
                        }

                        if (conditionMet) {
                            foundCount++;

                            const filename = `${row.node1}-${row.node2}.geojson`;

                            const url = geojsonFolder + filename;

                            console.log(`Condition met for ${dataType}. Drawing: ${url}`);

                            drawGeoJSON(url, color, 15, 0.3);
                        }
                    });

                    console.log(`Found ${foundCount} items for dataType '${dataType}'.`);

                    if (foundCount === 0) {
                        showToast(`'${dataType}' に該当するデータが見つかりませんでした。`, 'info');
                    }
                }
            };

            const calc = () => {
                var param1 = document.getElementById('param1').value;
                var param2 = document.getElementById('param2').value;
                var weight0 = document.getElementById('weight0').value;
                var weight1 = document.getElementById('weight1').value;
                var weight2 = document.getElementById('weight2').value;
                var weight3 = document.getElementById('weight3').value;
                var weight4 = document.getElementById('weight4').value;
                var weight5 = document.getElementById('weight5').value;
                var weight6 = document.getElementById('weight6').value;
                var weight7 = document.getElementById('weight7').value;
                var weight8 = document.getElementById('weight8').value;
                var weight9 = document.getElementById('weight9').value;
                var weight10 = document.getElementById('weight10').value;
                var weight11 = document.getElementById('weight11').value;
                var weight12 = document.getElementById('weight12').value;
                var walkingSpeed = document.getElementById('walking-speed').value;
                const baseUrl = window.location.origin;

                return fetch(`${baseUrl}/calc`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `param1=${encodeURIComponent(param1)}&param2=${encodeURIComponent(
                        param2
                    )}&weight0=${encodeURIComponent(weight0)}&weight1=${encodeURIComponent(
                        weight1
                    )}&weight2=${encodeURIComponent(weight2)}&weight3=${encodeURIComponent(
                        weight3
                    )}&weight4=${encodeURIComponent(weight4)}&weight5=${encodeURIComponent(
                        weight5
                    )}&weight6=${encodeURIComponent(weight6)}&weight7=${encodeURIComponent(
                        weight7
                    )}&weight8=${encodeURIComponent(weight8)}&weight9=${encodeURIComponent(
                        weight9
                    )}&weight10=${encodeURIComponent(weight10)}&weight11=${encodeURIComponent(
                        weight11
                    )}&weight12=${encodeURIComponent(weight12)}&walkingSpeed=${encodeURIComponent(walkingSpeed)}`,
                })
                    .then((response) => {
                        if (!response.ok) {
                            return response.json().then(err => { throw new Error(err.error || `HTTP error! status: ${response.status}`) });
                        }
                        return response.json();
                    })
                    .then((output) => {
                        console.log('計算完了:', output);
                        return output;
                    });
            };

            const clearGeoJSON = () => {
                [...route1.layers, ...route2.layers, ...savedRoute.layers, ...otherLayers].forEach(
                    (layer) => {
                        map.removeLayer(layer);
                    }
                );
                route1 = { info: null, segments: [], layers: [] };
                route2 = { info: null, segments: [], layers: [] };
                savedRoute = { info: null, layers: [] };
                otherLayers = [];
                updateRouteInfoDisplay();
            };

            let geojsonFeatures_near = [];
            let geojsonFileNames_near = [];

            // ノードGeoJSONをロード（必要数は適宜調整）
            const pointPromises = [];
            for (let i = 1; i <= 300; i++) {
                const fileName = `${i}.geojson`;
                const filePath = './oomiya_point/' + fileName;
                pointPromises.push(
                    fetch(filePath)
                        .then((response) => {
                            if (response.ok) {
                                return response.json().then((geojsonData) => {
                                    geojsonFeatures_near.push(geojsonData);
                                    geojsonFileNames_near.push(fileName);
                                });
                            }
                        })
                        .catch(() => {
                            /* 存在しないファイルは無視 */
                        })
                );
            }
            Promise.all(pointPromises).then(() => {
                console.log(`${geojsonFeatures_near.length} points loaded.`);
            });

            const blueIcon = new L.Icon({
                iconUrl:
                    'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                shadowUrl:
                    'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41],
            });

            let startMarker = null;

            const displayCoordinates = (lat, lng) => {
                const coordDisplay = document.getElementById('coord-display');
                if (coordDisplay) {
                    coordDisplay.innerHTML = `緯度: ${lat.toFixed(6)}, 経度: ${lng.toFixed(6)}`;
                }
            };

            map.on('click', function (e) {
                displayCoordinates(e.latlng.lat, e.latlng.lng);

                if (geojsonFeatures_near.length === 0) {
                    alert('GeoJSONデータがまだ読み込まれていません。');
                    return;
                }

                const clickedPoint = turf.point([e.latlng.lng, e.latlng.lat]);
                let nearestPoint = null;
                let nearestFile = null;
                let minDistance = Infinity;

                geojsonFeatures_near.forEach(function (feature, index) {
                    const currentPoint = turf.point(feature.geometry.coordinates);
                    const distance = turf.distance(clickedPoint, currentPoint, {
                        units: 'kilometers',
                    });
                    if (distance < minDistance) {
                        minDistance = distance;
                        nearestPoint = feature;
                        nearestFile = geojsonFileNames_near[index];
                    }
                });

                if (nearestPoint) {
                    if (startMarker) {
                        map.removeLayer(startMarker);
                    }

                    startMarker = L.marker(
                        [
                            nearestPoint.geometry.coordinates[1],
                            nearestPoint.geometry.coordinates[0],
                        ],
                        { icon: blueIcon }
                    )
                        .addTo(map)
                        .bindPopup(`始点: ${nearestFile.replace('.geojson', '')}`)
                        .openPopup();

                    document.getElementById('param1').value = nearestFile.replace('.geojson', '');
                }
            });

            const syncValues = (source, targetId) => {
                const target = document.getElementById(targetId);
                target.value = source.value;
            };

            const viewAREA = async (filePath) => {
                try {
                    const response = await fetch(filePath);
                    if (!response.ok)
                        throw new Error(`Failed to fetch GeoJSON file: ${response.statusText}`);
                    const geojsonData = await response.json();
                    var geojsonLayer = L.geoJSON(geojsonData, {
                        style: { color: 'black', weight: 8, opacity: 0.5 },
                    }).addTo(map);
                    otherLayers.push(geojsonLayer);
                } catch (error) {
                    console.error('Error loading GeoJSON:', error);
                }
            };

            const loadSavedRoutesList = async () => {
                try {
                    const response = await fetch('/list_saved_routes');
                    const files = await response.json();
                    const dropdown = document.getElementById('saved-routes-dropdown');
                    dropdown.innerHTML = '';
                    if (files.length === 0) {
                        const option = document.createElement('option');
                        option.textContent = '保存されたルートはありません';
                        dropdown.appendChild(option);
                    } else {
                        files.forEach((file) => {
                            const option = document.createElement('option');
                            option.value = file;
                            option.textContent = file;
                            dropdown.appendChild(option);
                        });
                    }
                } catch (error) {
                    console.error('保存済みルート一覧の取得に失敗:', error);
                }
            };

            const loadSelectedRoute = async () => {
                const dropdown = document.getElementById('saved-routes-dropdown');
                const fileName = dropdown.value;
                if (!fileName || fileName === '保存されたルートはありません') {
                    alert('呼び出すルートを選択してください。');
                    return;
                }
                try {
                    setLoadingState(true, 'ルートを読み込んでいます...');
                    const response = await fetch(
                        `/get_saved_route?fileName=${encodeURIComponent(fileName)}`
                    );
                    if (!response.ok) {
                        throw new Error(
                            `サーバーからのルート取得に失敗しました: ${response.statusText}`
                        );
                    }
                    const csvContent = await response.text();
                    await drawSavedRoute(csvContent);
                } catch (error) {
                    console.error('ルートの読み込みエラー:', error);
                    alert(error.message);
                } finally {
                    setLoadingState(false);
                }
            };

            window.addEventListener('load', function () {
                loadCSVData();
                loadSavedRoutesList();
                setTimeout(() => map.invalidateSize(), 100); // Ensure map renders correctly after layout changes
            });
        </script>
    </body>
</html>
